<script>
document.addEventListener('DOMContentLoaded', () => {
  // 顯示當天日期
  const currentDate = new Date();
  const formattedDate = currentDate.toLocaleDateString();
  document.getElementById('current-date').textContent = `日期: ${formattedDate}`;

  const tbody = document.getElementById('tbody');
  const heights = [0.84, 4.04, 0.84, 4.04, 0.84, 4.04];
  
  // 生成6行 × 20列（與原本相同）
  heights.forEach(h => {
    const tr = document.createElement('tr');
    tr.style.height = h + 'cm';
    for (let c = 1; c <= 20; c++) {
      const td = document.createElement('td');
      const input = document.createElement('input');
      input.type = 'text';
      td.appendChild(input);
      tr.appendChild(td);
    }
    tbody.appendChild(tr);
  });

  document.getElementById('bulk-load').onclick = () => {
    // 1. 拆分並解析 raw 資料
    const raw = document.getElementById('bulk-input').value;
    const items = raw.split(/\r?\n|,/)
                     .map(v => v.trim())
                     .filter(v => v);
    const records = items.map(item => {
      const idx = [...item].findIndex(ch => /[\u4e00-\u9fff]/.test(ch));
      if (idx < 0) return { date: item, name: '' };
      if (idx === 0) return { date: '', name: item };
      return { date: item.slice(0, idx), name: item.slice(idx) };
    });

    // 2. 建立「今天」的日期物件（只取年月日，不包含時分秒）
    const todaySrc = new Date();
    const today = new Date(todaySrc.getFullYear(), todaySrc.getMonth(), todaySrc.getDate());

    // 3. 過濾：沒有日期的保留；有日期（M/D）且該日期 >= 今天的才保留
    const filtered = records.filter(r => {
      if (!r.date) return true;
      const parts = r.date.split('/').map(n => parseInt(n, 10));
      if (parts.length !== 2 || isNaN(parts[0]) || isNaN(parts[1])) return false;
      const recDate = new Date(today.getFullYear(), parts[0] - 1, parts[1]);
      return recDate >= today;
    });

    // 4. 清空所有儲存格
    document.querySelectorAll('input').forEach(i => i.value = '');

    // 5. 計算每筆要填入的欄位（以 filtered 長度為準）
    filtered.forEach((r, k) => {
      // 日期放前面 20 格
      const dp = k < 20 ? k : (k < 40 ? k + 20 : k + 40);
      const dr = Math.floor(dp / 20), dc = dp % 20;
      const dateCell = tbody.children[dr].querySelectorAll('input')[dc];
      if (r.date) dateCell.value = r.date;

      // 姓名放後面 20 格
      const np = k < 20 ? 20 + k : (k < 40 ? 40 + k : 60 + k);
      const nr = Math.floor(np / 20), nc = np % 20;
      const nameCell = tbody.children[nr].querySelectorAll('input')[nc];
      if (r.name) nameCell.value = r.name;
    });
  };
});
</script>
